<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8">
	<style>
	table, th, td {
		border: 1px solid black;
	}
	</style>
	<script src="ajax5.js"></script>



	<script type="text/javascript" src="instrucao.js"></script>
	<script type="text/javascript" src="LineModel1.js"></script>
	<script type="text/javascript" src="LineModel2.js"></script>
	<script type="text/javascript" src="LineModel3.js"></script>
	<script type="text/javascript" src="instructionStatus.js"></script>
	<script type="text/javascript" src="reservationStation.js"></script>
	<script type="text/javascript" src="registerFile.js"></script>
	<script type="text/javascript" src="Foto.js"></script>
	<script type="text/javascript">		

 		function init(){
			var listaInstrucoes  = carregarDados();
			var listadeFotos = [];
			resolverTomasulo(listaInstrucoes,listadeFotos);

		}

		function carregarDados(){
			var listaInstrucoes = [];
			//criar lista de instruções Rafael, ja colocando a latencia junto com as instruções;		
			var quantidade = parseInt(window.localStorage.getItem("quantidade"));
	
			var id = 0;
			for(i = 0; i < quantidade; i++) { 
				var nome = window.localStorage.getItem("instrucao"+i).value;
				var op0 = window.localStorage.getItem("reg1"+i).value;
				var op1 = window.localStorage.getItem("reg2"+i).value;
				var op2 = window.localStorage.getItem("reg3"+i).value;
				var l = 0;
				if(nome == "ADD.D" || nome == "SUBD" || nome == "DADDUI"){
					l = window.localStorage.getItem("qtdAdd").value;
				}
				else if(nome == "MULTD"){
					l = window.localStorage.getItem("qtdMult").value;
				}
				else if(nome == "DIV.D"){
					l = window.localStorage.getItem("qtdDiv").value;
				}
				else if(nome == "L.D"){
					l = window.localStorage.getItem("qtdLoad").value;							 	
				}
				else if(nome == "S.D"){
					window.localStorage.getItem("qtdStore").value;
				}
				else{
					//TODO - LER A DURACAO DE INTEIROS (RAFAEL)
					l = 1;
				}			 					 					 		

				listaInstrucoes[i] = new Instrucao(nome,op0,op1,op2,l)
				id += 4;
			}									
			return listaInstrucoes;
		}

		function resolverTomasulo(listaInstrucoes,listadeFotos){
			//incializar dados
			var listaInstrucoesPronta = [listaInstrucoes.length];
			var fimExecucao = [listaInstrucoes.length];
			for(var i = 0; i < listaInstrucoesPronta.length; i++){
				listaInstrucoesPronta[i] = false;
				fimExecucao[i] = -1;
			}
			
			var pc = 0;
			var clock = 1;
			
			var instructionStatus = new InstructionStatus(listaInstrucoes.length);
			var reservationStation = new ReservationStation();
			var registerFile = new RegisterFile();			
			var contGlobal = {value:0};						
			//criando foto 0
			listadeFotos.push(new Foto(instructionStatus,reservationStation,registerFile,0));
			//resolver algoritmo
			while(!resolveuTudo(listaInstrucoesPronta)){
				//despachar a instrução
				var despachou = despachar(pc,listaInstrucoes[pc],clock,instructionStatus,reservationStation,registerFile,contGlobal);

				//Executar processamento nesse ciclo
				atualizar(pc,listaInstrucao,listaInstrucoesPronta,clock,instructionStatus,reservationStation,fimExecucao,registerFile,contGlobal);

				//tirar foto já inserindo na lista de resolução
				var foto = new Foto(instructionStatus,reservationStation,registerFile,clock);
				listadeFotos.push(foto);

				//incrementar pc caso houve despacho
				if(despachou){
					pc++;
				}
				//incrementar o clock
				clock++;
				alert(clock);
			}
		}

		function atualizar(pc,listaInstrucao,listaInstrucoesPronta,clock,instructionStatus,reservationStation,fimExecucao,registerFile,contGlobal){
			//verificar se a instrucao i terminou
			for(var i = 0; i < pc-1; i++){
				if(!listaInstrucoesPronta[i]){
					//não começou a executar
					if(fimExecucao[i] == -1){
						//verificar porque não começou
						var instrucao = listaInstrucao[i];
						var unidadeEnome = acharUnidade(instrucao,reservationStation);
						var unidade = unidadeEnome[0];
						var nome = unidadeEnome[1];
						var pos = instrucao.posicaoUnidade;
						var podeExecutar = false;
						if(nome != "Store" && nome != "Load"){
							if(unidade[pos].vj != "" && unidade[pos].vk != ""){
								podeExecutar = true;
							}
						}	
						else if(nome != "Load"){
							if(unidade[pos].vj != ""){
								podeExecutar = true;
							}
						}
						//caso seja load, sempre executa
						else{
							podeExecutar = true;
						}

						if(podeExecutar){
							fimExecucao[i] = clock-1+instrucao.latencia;
						}
					}
					else if(fimExecucao[i] == clock){
						//execution complete
						instructionStatus.matrizStatus[i][1] = clock;

					}
					else if(fimExecucao[i]+1 == clock){
						//escrever resultado
						instructionStatus.matrizStatus[i][2] = clock;
						var instrucao = listaInstrucao[i];
						var posicao = registerFile.acharPosicao(instrucao.op0);
						atualizaReservationStation(registerFile.apelido[posicao],reservationStation,contGlobal,instrucao);				
						registerFile.apelido[posicao] = instrucao.op0+"_"+contGlobal.value;
						contGlobal.value++;
						listaInstrucoesPronta[i] = true;
						limparUnidade(reservationStation,instrucao);
					}		
				}

			}
		}

		function limparUnidade(reservationStation,instrucao){
			var linha;
			var achou = false;
			//reseta linha model 1
			if(instrucao.nome == "ADD.D" || instrucao.nome == "SUBD" || instrucao.nome == "DADDUI"){
				linha = reservationStation.adds[instrucao.posicaoUnidade];							
				achou = true;
			}
			else if(instrucao.nome == "MULTD" || instrucao.nome == "DIV.D"){
				linha = reservationStation.mult[instrucao.posicaoUnidade];							
				achou = true;
			}
			else if(instrucao.nome == "ADD"){
				linha = reservationStation.integer[instrucao.posicaoUnidade];							
				achou = true;
			if(achou){
				linha.busy = false;
				linha.op = "";
				linha.vj = "";
				linha.qj = "";
				linha.vk = "";
				linha.qk = "";	
			}
			//reseta linha model 3			
			if(instrucao.nome == "L.D"){
				linha = reservationStation.load[instrucao.posicaoUnidade];
				linha.address = "";
				linha.busy = false;
			}
			//reseta linha model2
			else if(instrucao.nome == "S.D"){
				linha = reservationStation.load[instrucao.posicaoUnidade];
				linha.address = "";
				linha.qj = "";
				linha.vj = "";
				linha.busy = false;
			}			
		}

		function atualizaReservationStation(apelido,reservationStation,contGlobal,instrucao){
			for(var linha in reservationStation.adds){
				if(linha.qj == apelido){
					linha.vj = instrucao.op0+"_"+contGlobal.value;
					linha.qj = "";
				}
				if(linha.qk == apelido){
					linha.vk = instrucao.op0+"_"+contGlobal.value;
					linha.qk = "";
				}
			}
			for(var linha in reservationStation.mult){
				if(linha.qj == apelido){
					linha.vj = instrucao.op0+"_"+contGlobal.value;
					linha.qj = "";
				}
				if(linha.qk == apelido){
					linha.vk = instrucao.op0+"_"+contGlobal.value;
					linha.qk = "";
				}
			}
			for(var linha in reservationStation.integer){
				if(linha.qj == apelido){
					linha.vj = instrucao.op0+"_"+contGlobal.value;
					linha.qj = "";
				}
				if(linha.qk == apelido){
					linha.vk = instrucao.op0+"_"+contGlobal.value;
					linha.qk = "";
				}
			}			
			for(var linha in reservationStation.store){
				if(linha.qj == apelido){
					linha.vj = instrucao.op0+"_"+contGlobal.value;
					linha.qj = "";
				}				
			}
		}

		function despachar(pc,instrucao,clock,instructionStatus,reservationStation,registerFile,contGlobal){
			var unidadeEnome = acharUnidade(instrucao,reservationStation);
			var unidade = unidadeEnome[0];
			var nomeUnidade = unidadeEnome[1];
			var i = 0;
			var linhaDisponivel = false;
			//verifico se a unidade está ocupada
			for(i = 0; i < unidade.length; i++){
				if(!unidade[i].busy){
					linhaDisponivel = true;
					break;
				}
			}
			if(linhaDisponivel){			
				//informei qual linha da unidade se encontra a dada instrução
				instrucao.posicaoUnidade = i;
				var posicaoNoFU = registerFile.acharPosicao(instrucao.op0);
				registerFile.registerSolved[posicaoNoFU] = false;
				var x = i+1;
				registerFile.apelido[posicaoNoFU] = nomeUnidade+x;

				//despachando para a unidade correta
				unidade[i].busy = true;
				if(nomeUnidade == "Add" || nomeUnidade == "Mult" || nomeUnidade == "Integer"){
					unidade[i].op = instrucao.nome;
					var j = registerFile.acharPosicao(instrucao.op1);
					var k = registerFile.acharPosicao(instrucao.op2);
					if(registerFile.registerSolved[j] == true){
						if(registerFile.apelido[j] == ""){
							unidade[i].vj = instrucao.op1+"_"+contGlobal.value;
							contGlobal.value++;
						}
						else{
							unidade[i].vj = registerFile.apelido[j];
						}						
					}
					else{
						unidade[i].qj = registerFile.apelido[j];
					}
					if(registerFile.registerSolved[k] == true){
						if(registerFile.apelido[k] == ""){
							unidade[i].vk = instrucao.op2+"_"+contGlobal.value;
							contGlobal.value++;
						}
						else{
							unidade[i].vk = registerFile.apelido[k];
						}
					}
					else{
						unidade[i].qk = registerFile.apelido[k];
					}					
				}
				else if(nomeUnidade == "Store"){
					if(registerFile.registerSolved[posicaoNoFU] == true){
						if(registerFile.apelido[posicaoNoFU] == ""){
							unidade[i].vj = instrucao.op0+"_"+contGlobal.value;
							contGlobal.value++;
						}
						else{
							unidade[i].vj = registerFile.apelido[posicaoNoFU];
						}						
					}
					else{
						unidade[i].qj = registerFile.apelido[posicaoNoFU];
					}
					unidade[i].address = instrucao.op1+"+"+instrucao.op2;
				}
				else{
					unidade[i].address = instrucao.op1+"+"+instrucao.op2;
				}
				instructionStatus.matrizStatus[pc][0] = clock;
				return true;
			}
			//não teve linha na unidade disponivel para ser despachado
			return false;
		}

		/*Função que acha qual unidade deve ir a instrucao*/
		function acharUnidade(instrucao,reservationStation){
			if(instrucao.nome == "ADD.D" || instrucao.nome == "SUBD" || instrucao.nome == "DADDUI"){
				return [reservationStation.adds,"Add"];
			}
			else if(instrucao.nome == "MULTD" || instrucao.nome == "DIV.D"){
				return [reservationStation.mult,"Mult"];
			}
			else if(instrucao.nome == "L.D"){
				return [reservationStation.load,"Load"];
			}
			else if(instrucao.nome == "S.D"){
				return [reservationStation.store,"Store"];
			}
			else{
				return [reservationStation.integer,"Integer"];
			}
		}

		function resolveuTudo(lista){
			for(var boolean in lista){
				if(!boolean){
					return false;
				}
			}
			return true;
		}



		function update(){

		}

		function prev(){

		}

	</script>







	<script>
		window.onload = montaTabelas;
		var teste = window.localStorage.getItem("instrucao0")
		var quantidade = parseInt(window.localStorage.getItem("quantidade"));
		function montaTabelas() {
			montaTabelaInstr();
			montaInstrStation();
			montaLoadU();
			montaStoreU();
			montaReservStation();
			montaRegisterStation();
		}		
		function montaTabelaInstr() {
			var out = "";
			var i;
			out += "<table id=\"instrucoes\">";
			for(i=0; i < quantidade; i++){
				var id = i*4;
				out += "<tr>";
				out += "<td id=\""+id+"\"></td><td id=\""+(id+1)+"\"></td><td id=\""+(id+2)+"\"></td><td id=\""+(id+3)+"\"></td>";
				out += "</tr>";
			}
			out += "</table>";	
			document.getElementById("teste").innerHTML = out;
			var id = 0;
			for(i = 0; i < quantidade; i++) { 
				document.getElementById(id).innerHTML = window.localStorage.getItem("instrucao"+i);
				document.getElementById(id+1).innerHTML = window.localStorage.getItem("reg1"+i);
				document.getElementById(id+2).innerHTML = window.localStorage.getItem("reg2"+i);
				document.getElementById(id+3).innerHTML = window.localStorage.getItem("reg3"+i);
				id += 4;
			}
			document.getElementById("qL").innerHTML = window.localStorage.getItem("qtdLoad");
			document.getElementById("qS").innerHTML = window.localStorage.getItem("qtdStore");
			document.getElementById("qAS").innerHTML = window.localStorage.getItem("qtdAdd");
			document.getElementById("qM").innerHTML = window.localStorage.getItem("qtdMult");
			document.getElementById("qD").innerHTML = window.localStorage.getItem("qtdDiv");
				
		}
		function montaInstrStation() {
			var out = "";
			var i;
			out += "<table id=\"instrStation\">";
			out += "<tr><th>Issue</th><th>Exec comp</th><th>Write Result</th></tr>";
			for(i = 0; i < quantidade; i++) {
				out += "<tr>";
				out += "<td></td><td></td><td></td>";
				out += "</tr>";
			}
			out += "</table>";
			document.getElementById("instructionStation").innerHTML = out;
		}
		function montaLoadU() {
			var out = "";
			var i;
			out += "<table id=\"loadStation\">";
			out += "<tr><th>Name</th><th>Busy</th><th>Address</th><th>Funct Unit</th></tr>";
			for(i = 0; i < quantidade; i++) {
				out += "<tr>";
				out += "<td></td><td></td><td></td><td></td>";
				out += "</tr>";
			}
			out += "</table>";
			document.getElementById("loadStation").innerHTML = out;
		}
		function montaStoreU() {
			var out = "";
			var i;
			out += "<table id=\"storeStation\">";
			out += "<tr><th>Name</th><th>Busy</th><th>Address</th><th>FunctUnit</th></tr>";
			for(i = 0; i < quantidade; i++) {
				out += "<tr>";
				out += "<td></td><td></td><td></td><td></td>";
				out += "</tr>";
			}
			out += "</table>";
			document.getElementById("storeStation").innerHTML = out;
		}
		function montaReservStation() {
			var out = "";
			var i;
			out += "<table id=\"reservStation\">";
			out += "<tr><th>Name</th><th>Busy</th><th>Op</th><th>Vj</th><th>Vk</th><th>Qj</th><th>Qk</th><th>time</th></tr>";
			for(i = 0; i < quantidade; i++) {
				out += "<tr>";
				out += "<td></td><td></td><td></td>";
				out += "</tr>";
			}
			out += "</table>";
			document.getElementById("reservStation").innerHTML = out;
		}	
		function montaRegisterStation() {
			var out = "";
			var i;
			out += "<table id=\"registerStation\">";
			out += "<tr>";
			for(i = 0; i < 31; i += 2) {
				out += "<th>F"+i+"</th>";
			}
			out += "</tr>";
			out += "<tr>";
			for(i = 0; i < 31; i += 2) {
				out += "<td></td>";
			}
			out += "</tr>";
			out += "</table>";
			document.getElementById("regStation").innerHTML = out;
		}
	</script>
</head>
<body onLoad="init();">
	<div id="teste">
	</div>
	<div>
		<table>
		<tr>
			<th>Load</th>	
			<th>Store</th>
			<th>Add/Sub</th>
			<th>Mult</th>
			<th>Div</th>
		</tr>
		<tr>
			<td id="qL"></td>
			<td id="qS"></td>
			<td id="qAS"></td>
			<td id="qM"></td>
			<td id="qD"></td>
		</tr>
		</table>
	</div>
	<div id="instructionStation">
	</div>
	<div id="loadStation">
	</div>
	<div id="storeStation">
	</div>
	<div id="reservStation">
	</div>
	<div id="regStation">
	</div>
	<input type="button" id="prev" onClick="prev();" value="voltar">
	<input type="button" id="prox" onClick="update();" value="proximo">
</body>
</html>


 
